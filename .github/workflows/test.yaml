name: 'test'
on:
    pull_request:
        types: [opened, edited, synchronize]

jobs:
    validate-jira:
        runs-on: ubuntu-latest
        steps:
            - name: Setup dependencies
              run: |
                  # Install curl and jq if not present (for act compatibility)
                  if ! command -v curl &> /dev/null; then
                      apt-get update -y && apt-get install -y curl jq
                  fi
            - name: Extract ISSUE_KEY from PR description
              id: extract_issue
              run: |
                  PR_BODY='${{ github.event.pull_request.body }}'
                  echo "PR Description: $PR_BODY"

                  # Extract ISSUE_KEY from {ISSUE_KEY} pattern in PR description
                  ISSUE_KEY=$(echo "$PR_BODY" | grep -oP '\{[A-Z]+-[0-9]+\}' | head -1 | tr -d '{}')

                  if [ -z "$ISSUE_KEY" ]; then
                    echo "‚ùå No ISSUE_KEY found in PR description. Please add {ISSUE_KEY} to the PR description."
                    exit 1
                  fi

                  echo "‚úÖ Extracted ISSUE_KEY: $ISSUE_KEY"
                  echo "ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_OUTPUT
            - name: Fetch Jira issue
              id: fetch_jira
              env:
                  JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
                  JIRA_TOKEN: ${{ secrets.JIRA_TOKEN }}
                  ISSUE_KEY: ${{ steps.extract_issue.outputs.ISSUE_KEY }}
                  BASE_URL: ${{ secrets.JIRA_URL }}
              run: |
                  set -e

                  echo "| üîç Fetching JIRA issue: $ISSUE_KEY"
                  echo "| üì° From: $BASE_URL/rest/api/3/issue/$ISSUE_KEY"

                  RESPONSE=$(curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" \
                    -X GET \
                    -H "Accept: application/json" \
                    "$BASE_URL/rest/api/3/issue/$ISSUE_KEY")

                  PRIORITY=$(echo "$RESPONSE" | jq -r '.fields.priority.name // "None"')
                  LABELS=$(echo "$RESPONSE" | jq -r 'if (.fields.labels | length) > 0 then [.fields.labels[]] | join(", ") else "None" end')
                  TASK_URL="$BASE_URL/browse/$ISSUE_KEY"

                  echo ""
                  echo "Task: $TASK_URL"
                  echo "Priority: $PRIORITY"
                  echo "Labels: $LABELS"

                  # Save outputs for next step
                  echo "TASK_URL=$TASK_URL" >> $GITHUB_OUTPUT
                  echo "PRIORITY=$PRIORITY" >> $GITHUB_OUTPUT
                  echo "LABELS=$LABELS" >> $GITHUB_OUTPUT
            - name: Update PR description with Jira info
              env:
                  GH_TOKEN: ${{ github.token }}
                  ISSUE_KEY: ${{ steps.extract_issue.outputs.ISSUE_KEY }}
                  TASK_URL: ${{ steps.fetch_jira.outputs.TASK_URL }}
                  PRIORITY: ${{ steps.fetch_jira.outputs.PRIORITY }}
                  LABELS: ${{ steps.fetch_jira.outputs.LABELS }}
              run: |
                  # Get current PR body
                  PR_BODY='${{ github.event.pull_request.body }}'

                  # Create replacement text (3 lines)
                  JIRA_INFO="Task: $TASK_URL
                  Priority: $PRIORITY
                  Labels: $LABELS"

                  # Replace {ISSUE_KEY} (e.g., {CTRL-232}) with the Jira information
                  UPDATED_BODY="${PR_BODY//\{$ISSUE_KEY\}/$JIRA_INFO}"

                  echo ""
                  echo "=========================================="
                  echo "üìù Updated PR Description:"
                  echo "=========================================="
                  echo "$UPDATED_BODY"
                  echo "=========================================="
                  echo ""

                  # Update PR description using GitHub CLI (only on real GitHub Actions)
                  if [ -n "${{ github.event.pull_request.number }}" ] && command -v gh &> /dev/null; then
                    echo "$UPDATED_BODY" | gh pr edit ${{ github.event.pull_request.number }} --body-file - || echo "‚ö†Ô∏è Running locally - skipping actual PR update"
                  else
                    echo "‚ö†Ô∏è Running locally - skipping actual PR update"
                  fi

                  echo "‚úÖ PR description prepared with Jira information"
