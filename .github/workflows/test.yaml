name: 'test'
on:
    pull_request:
        types: [opened, edited, synchronize]

permissions:
    pull-requests: write
    contents: read

jobs:
    validate-jira:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
            - name: Setup dependencies
              run: |
                  # Install curl and jq if not present (for act compatibility)
                  if ! command -v curl &> /dev/null; then
                      apt-get update -y && apt-get install -y curl jq
                  fi
            - name: Extract ISSUE_KEY from PR description
              id: extract_issue
              run: |
                  PR_BODY='${{ github.event.pull_request.body }}'
                  echo "PR Description: $PR_BODY"

                  # Extract ISSUE_KEY from {ISSUE_KEY} pattern in PR description
                  ISSUE_KEY=$(echo "$PR_BODY" | grep -oP '\{[A-Z]+-[0-9]+\}' | head -1 | tr -d '{}')

                  if [ -z "$ISSUE_KEY" ]; then
                    echo "‚ö†Ô∏è WARNING: No ISSUE_KEY found in PR description. Skipping Jira validation."
                    echo "ISSUE_KEY=" >> $GITHUB_OUTPUT
                    echo "SKIP_JIRA=true" >> $GITHUB_OUTPUT
                  else
                    echo "‚úÖ Extracted ISSUE_KEY: $ISSUE_KEY"
                    echo "ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_OUTPUT
                    echo "SKIP_JIRA=false" >> $GITHUB_OUTPUT
                  fi
            - name: Fetch Jira issue
              if: steps.extract_issue.outputs.SKIP_JIRA != 'true'
              id: fetch_jira
              env:
                  JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
                  JIRA_TOKEN: ${{ secrets.JIRA_TOKEN }}
                  ISSUE_KEY: ${{ steps.extract_issue.outputs.ISSUE_KEY }}
                  BASE_URL: ${{ secrets.JIRA_URL }}
              run: |
                  set -e

                  echo "| üîç Fetching JIRA issue: $ISSUE_KEY"
                  echo "| üì° From: $BASE_URL/rest/api/3/issue/$ISSUE_KEY"

                  RESPONSE=$(curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" \
                    -X GET \
                    -H "Accept: application/json" \
                    "$BASE_URL/rest/api/3/issue/$ISSUE_KEY")

                  PRIORITY=$(echo "$RESPONSE" | jq -r '.fields.priority.name // "None"')
                  LABELS=$(echo "$RESPONSE" | jq -r 'if (.fields.labels | length) > 0 then [.fields.labels[]] | join(", ") else "None" end')
                  TASK_URL="$BASE_URL/browse/$ISSUE_KEY"

                  echo ""
                  echo "Task: $TASK_URL"
                  echo "Priority: $PRIORITY"
                  echo "Labels: $LABELS"

                  # Save outputs for next step
                  echo "TASK_URL=$TASK_URL" >> $GITHUB_OUTPUT
                  echo "PRIORITY=$PRIORITY" >> $GITHUB_OUTPUT
                  echo "LABELS=$LABELS" >> $GITHUB_OUTPUT
            - name: Preview PR description update (for local testing)
              if: ${{ env.ACT && steps.extract_issue.outputs.SKIP_JIRA != 'true' }}
              run: |
                  PR_BODY='${{ github.event.pull_request.body }}'
                  ISSUE_KEY='${{ steps.extract_issue.outputs.ISSUE_KEY }}'
                  JIRA_INFO="Task: ${{ steps.fetch_jira.outputs.TASK_URL }}
                  Priority: ${{ steps.fetch_jira.outputs.PRIORITY }}
                  Labels: ${{ steps.fetch_jira.outputs.LABELS }}"

                  UPDATED_BODY="${PR_BODY//\{$ISSUE_KEY\}/$JIRA_INFO}"

                  echo ""
                  echo "=========================================="
                  echo "üìù Preview - Updated PR Description:"
                  echo "=========================================="
                  echo "$UPDATED_BODY"
                  echo "=========================================="
                  echo ""
                  echo "‚ö†Ô∏è Running with act - This is just a preview"
            - name: Update PR description with Jira info
              if: ${{ !env.ACT && steps.extract_issue.outputs.SKIP_JIRA != 'true' }}
              uses: nefrob/pr-description@v1.2.0
              with:
                  content: |
                      Task: ${{ steps.fetch_jira.outputs.TASK_URL }}
                      Priority: ${{ steps.fetch_jira.outputs.PRIORITY }}
                      Labels: ${{ steps.fetch_jira.outputs.LABELS }}
                  regex: '\{${{ steps.extract_issue.outputs.ISSUE_KEY }}\}'
                  regexFlags: 'g'
                  token: ${{ secrets.GITHUB_TOKEN }}
